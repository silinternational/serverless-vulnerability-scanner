'use strict';

const assert = require('assert')
const { convertToCsvString, getSecurityVulnerabilitiesForGitHubOrg } = require('@silintl/vulnerability-scanner')
const AWS = require('aws-sdk')

const s3 = new AWS.S3()

module.exports.scanOrg = async event => {
  assert(event.githubOrg, 'No githubOrg provided')
  assert(event.githubToken, 'No githubToken provided')
  assert(process.env.RESULTS_S3_BUCKET, 'No RESULTS_S3_BUCKET provided')
  assert(process.env.STAGE, 'No STAGE provided')
  
  const vulnerabilitiesByRepo = await getSecurityVulnerabilitiesForGitHubOrg(
    event.githubToken,
    event.githubOrg
  )
  const csvString = await convertToCsvString(vulnerabilitiesByRepo)
  
  try {
    const dateString = (new Date()).toISOString().substr(0, 10)
    const year = dateString.substr(0, 4)
    const month = dateString.substr(5, 2)
    const s3PutObjectParameters = {
      Bucket: process.env.RESULTS_S3_BUCKET,
      Key: `${process.env.STAGE}/${year}/${month}/${dateString}.csv`,
      Body: csvString,
    }
    
    const putResult = await s3.putObject(s3PutObjectParameters).promise()
    console.log(putResult)
  } catch (error) {
    console.error(error)
  }
}
