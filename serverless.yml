# service name must match the app_name variable in Terraform config, and must be no more than 24 characters
service: vulnerability-scanner

frameworkVersion: ^3.7

custom:
  bucketPrefix: ${env:RESULTS_S3_BUCKET_PREFIX}

provider:
  name: aws
  runtime: nodejs14.x
  deploymentBucket:
    blockPublicAccess: true
  iam:
    role:
      statements:
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource: "arn:aws:s3:::${self:custom.bucketPrefix}-${sls:stage}/*"
  logRetentionInDays: 14
  memorySize: 256
  timeout: 600

package:
  patterns:
    - '!node_modules/aws-sdk/**'

functions:
  scanOrg:
    handler: handler.scanOrg
    maximumRetryAttempts: 0
    environment:
      RESULTS_S3_BUCKET_PREFIX: ${self:custom.bucketPrefix}
      STAGE: ${sls:stage}
    events:
      - schedule:
          # cron(Minutes Hours Day-of-month Month Day-of-week Year)
          # Either `day-of-month` or `day-of-week` must be a question mark (?)
          rate: cron(5 0 * * ? *)
          input:
            bitbucketUsername: ${env:BITBUCKET_USERNAME, ''}
            bitbucketAppPassword: ${env:BITBUCKET_APP_PASSWORD, ''}
            bitbucketWorkspace: ${env:BITBUCKET_WORKSPACE, ''}
            githubOrg: ${env:GITHUB_ORG, ''}
            githubToken: ${env:GITHUB_TOKEN}
            versionsCsvUrl: ${env:VERSIONS_CSV_URL, ''}
